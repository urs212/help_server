<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>신고 웹사이트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form {
            max-width: 400px;
            margin: auto;
            display: flex;
            flex-direction: column;
        }
        label {
            margin-top: 10px;
        }
        input, textarea, button {
            margin-top: 5px;
            padding: 10px;
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #adminPanel {
            display: none;
            max-width: 800px;
            margin: 20px auto;
        }
        #adminPassword {
            max-width: 400px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>
    <h1>신고 웹사이트</h1>
    <form id="reportForm">
        <label for="nickname">닉네임:</label>
        <input type="text" id="nickname" name="nickname" required>

        <label for="discord">디스코드 닉네임:</label>
        <input type="text" id="discord" name="discord" required>

        <label for="description">내용:</label>
        <textarea id="description" name="description" rows="5" required></textarea>

        <label for="file">영상 또는 사진:</label>
        <input type="file" id="file" name="file" accept="image/*,video/*">

        <button type="button" onclick="submitReport()">신고하기</button>
    </form>

    <div id="adminPassword">
        <label for="password">관리자 비밀번호:</label>
        <input type="password" id="password">
        <button type="button" onclick="showAdminPanel()">관리자 모드</button>
    </div>

    <div id="adminPanel">
        <h2>신고 내역</h2>
        <table id="reportTable">
            <thead>
                <tr>
                    <th>닉네임</th>
                    <th>디스코드 닉네임</th>
                    <th>내용</th>
                    <th>파일</th>
                    <th>시간</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const adminPassword = "qwertyuiop";
        const GITHUB_REPO = "urs212/help_server"; // 본인의 GitHub 리포지토리 경로
        const FILE_PATH = "help.json"; // 업데이트할 JSON 파일 경로
        const TOKEN = "YOUR_PERSONAL_ACCESS_TOKEN"; // 생성한 Personal Access Token

        async function submitReport() {
            const nickname = document.getElementById('nickname').value;
            const discord = document.getElementById('discord').value;
            const description = document.getElementById('description').value;
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0] ? URL.createObjectURL(fileInput.files[0]) : "없음";

            const report = {
                nickname,
                discord,
                description,
                file,
                timestamp: new Date().toISOString()
            };

            await updateGitHubJSON(report);
            alert("신고가 완료되었습니다! 디스코드로 결과가 전송됩니다.");
        }

        async function updateGitHubJSON(newReport) {
            const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`;
            const headers = {
                Authorization: `token ${TOKEN}`,
                "Content-Type": "application/json",
            };

            try {
                // 기존 파일 가져오기
                const response = await fetch(url, { headers });
                const fileData = await response.json();
                const content = JSON.parse(atob(fileData.content));

                // 새로운 데이터 추가
                content.push(newReport);

                // 파일 업데이트
                const updatedContent = btoa(JSON.stringify(content, null, 2));
                await fetch(url, {
                    method: "PUT",
                    headers,
                    body: JSON.stringify({
                        message: "Update help.json",
                        content: updatedContent,
                        sha: fileData.sha,
                    }),
                });
            } catch (error) {
                console.error("Error updating GitHub JSON:", error);
                alert("신고 내용을 저장하는 데 실패했습니다. 다시 시도해주세요.");
            }
        }

        function showAdminPanel() {
            const password = document.getElementById('password').value;
            if (password === adminPassword) {
                const adminPanel = document.getElementById('adminPanel');
                const reportTableBody = document.getElementById('reportTable').querySelector('tbody');

                fetchReports().then((reports) => {
                    reportTableBody.innerHTML = '';
                    reports.forEach(report => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${report.nickname}</td>
                            <td>${report.discord}</td>
                            <td>${report.description}</td>
                            <td>${report.file !== "없음" ? `<a href="${report.file}" target="_blank">보기</a>` : "없음"}</td>
                            <td>${report.timestamp}</td>
                        `;
                        reportTableBody.appendChild(row);
                    });

                    adminPanel.style.display = 'block';
                });
            } else {
                alert("비밀번호가 올바르지 않습니다.");
            }
        }

        async function fetchReports() {
            const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`;
            const headers = {
                Authorization: `token ${TOKEN}`,
                "Content-Type": "application/json",
            };

            try {
                const response = await fetch(url, { headers });
                const fileData = await response.json();
                return JSON.parse(atob(fileData.content));
            } catch (error) {
                console.error("Error fetching GitHub JSON:", error);
                alert("신고 내역을 불러오는 데 실패했습니다.");
                return [];
            }
        }
    </script>
</body>
</html>
